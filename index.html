<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Three.js</title>
  </head>
  <body>
    <button onclick="startAnimation()">애니메이션 시작</button>
    <canvas id="canvas"></canvas>
  </body>
  <footer>
    <p>
        This work is based on "Game Ready Animated Mailbox / Postbox" (https://sketchfab.com/3d-models/game-ready-animated-mailbox-postbox-582c0ce1ffee41179ab981146ae0ff87) by OmegaRedZA (https://sketchfab.com/OmegaRedZA) licensed under CC-BY-4.0 (http://creativecommons.org/licenses/by/4.0/)
    </p>
  </footer>
</html>

<script type="importmap">
      {
  	"imports": {
      "three": "https://unpkg.com/three@0.138.3/build/three.module.js",
      "GLTFLoader":
      "https://unpkg.com/three@0.141.0/examples/jsm/loaders/GLTFLoader.js",
      "OrbitControls": "https://unpkg.com/three@0.141.0/examples/jsm/controls/OrbitControls.js"
    }
  }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from "GLTFLoader";

    // 1. 전역 변수 선언
    let scene, camera, renderer, loader, mixer;
    const controls = {
        isDragging: false,
        previousMousePosition: { x: 0, y: 0 },
        rotationSpeed: 0.005,
    };

    // 2. 씬 초기화
    function initScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color("skyblue");
    }

    // 3. 카메라 초기화
    function initCamera() {
        camera = new THREE.PerspectiveCamera(
            45,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(0, 1, 5);
    }

    // 4. 렌더러 초기화
    function initRenderer() {
        renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector("#canvas"),
            antialias: true,
        });
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // 5. 조명 설정
    function initLights() {
        const pointLight = new THREE.PointLight(0xffffff, 1);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        pointLight.position.set(50, 50, 50);
        scene.add(pointLight, ambientLight);
    }

    // 6. 모델 로드 및 최초 렌더링
    function loadModel() {
        loader = new GLTFLoader();
        loader.load("postbox/scene.gltf", (gltf) => {
            scene.add(gltf.scene);

            //모델 180도 회전
            gltf.scene.rotation.y = Math.PI;

            // 애니메이션 설정
            if (gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(gltf.scene);
                const clip = gltf.animations[0]; // 첫 번째 애니메이션 클립 사용
                const action = mixer.clipAction(clip);

                action.loop = THREE.LoopOnce; // 한 번만 실행
                action.clampWhenFinished = true; // 마지막 프레임에서 멈춤
                action.paused = true; // 초기 상태에서 멈춤
            }

            // 최초 렌더링
            renderer.render(scene, camera);
        });
    }

    // 7. 마우스 이벤트 핸들러
    function setupMouseControls() {
        document.addEventListener("mousedown", (event) => {
            controls.isDragging = true;
            controls.previousMousePosition = { x: event.clientX, y: event.clientY };
        });

        document.addEventListener("mousemove", (event) => {
            if (controls.isDragging) {
                const deltaX = event.clientX - controls.previousMousePosition.x;
                const deltaY = event.clientY - controls.previousMousePosition.y;

                scene.rotation.y += deltaX * controls.rotationSpeed;
                scene.rotation.x += deltaY * controls.rotationSpeed;

                controls.previousMousePosition = { x: event.clientX, y: event.clientY };
            }
        });

        document.addEventListener("mouseup", () => {
            controls.isDragging = false;
        });
    }

    // 8. 창 크기 변경 이벤트
    function setupResizeHandler() {
        window.addEventListener("resize", () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }

    // 9. 애니메이션 루프
    function animate() {
        const clock = new THREE.Clock();

        function render() {
            const delta = clock.getDelta();

            // 애니메이션 업데이트
            if (mixer) mixer.update(delta);

            // 씬 렌더링
            renderer.render(scene, camera);

            // 루프 반복
            requestAnimationFrame(render);
        }

        render();
    }

    // 10. 초기화 및 실행
    function main() {
        initScene();
        initCamera();
        initRenderer();
        initLights();
        loadModel();
        setupMouseControls();
        setupResizeHandler();
        animate();
    }

    /**
     * 애니메이션 실행 함수
    */
    function startAnimation() {
        if (action) {
            action.reset(); // 애니메이션 상태 초기화
            action.paused = false; // 멈춘 상태 해제
            action.play(); // 애니메이션 실행
        }
    }

    /**
     * 애니메이션 정지 함수
    */
    function stopAnimation() {
        if (action) {
            action.stop(); // 애니메이션 정지
        }
    }

    // 실행
    main();
</script>